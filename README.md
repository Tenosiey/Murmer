# Murmer

Murmer is a **self-hostable** minimal voice and text chat prototype.  It consists of
a Rust WebSocket server and a cross‑platform desktop client built with
Tauri and SvelteKit.

## Overview
* Persistent text chat backed by PostgreSQL
* Experimental voice chat using WebRTC
* User roles with customizable colors
* Image uploads stored on the server
* Cross-platform client powered by Tauri

## Prerequisites
- [Rust](https://www.rust-lang.org/tools/install)
- [Node.js](https://nodejs.org) 22+
- [Tauri prerequisites](https://v2.tauri.app/start/prerequisites/)

## Architecture
The repository contains a Tauri/SvelteKit client and a Rust WebSocket server.
The client lives under `murmer_client/` while the server code is in
`murmer_server/`. The provided `docker-compose.yml` starts the server together
with Postgres.

## Running the client
```bash
cd murmer_client
npm install
npm run tauri dev
```
This launches the desktop app.

## Running the server
### Prerequisites
Docker is required to host the server.

Use Docker Compose to run the server together with Postgres:
```bash
docker compose up --build
```
The server exposes a WebSocket endpoint at `ws://localhost:3001/ws`. The client can store multiple server URLs and connect to any of them via the "Servers" screen. Added servers are persisted locally so favorites remain after restart.
The `DATABASE_URL` used by the server is defined in `docker-compose.yml`.
If you set the `SERVER_PASSWORD` environment variable in `docker-compose.yml`, the server will require clients to provide that password when connecting.

On first launch the server creates a single text channel named `general`. Users
can create additional channels as needed, but no other channels are included by
default.

### Admin Roles

The server can assign custom roles to users. To enable this feature set the `ADMIN_TOKEN`
environment variable when launching the server. You can add it to
`docker-compose.yml` or export it in your shell before running `cargo run`.
The value should be a **secret string** of your choice, for example:

```bash
export ADMIN_TOKEN=my-admin-token
```
The same token must be provided in requests to the `/role` endpoint.

Use the `/role` endpoint to change a user's role. Send a POST request with an
`Authorization: Bearer <ADMIN_TOKEN>` header and a JSON body containing the
user's public key and desired role. An optional `color` field sets the hex color
displayed for that role:

```bash
curl -X POST http://localhost:3001/role \
     -H "Authorization: Bearer <ADMIN_TOKEN>" \
     -H "Content-Type: application/json" \
     -d '{"key":"<public-key>","role":"admin","color":"#eab308"}'
```

`<public-key>` is the base64 encoded Ed25519 public key generated by the client.
The next time that user connects, the server will send them a `role` message
indicating their assigned role.

The roles `Admin`, `Mod` and `Owner` are built-in and default to the colors
`#eab308`, `#10b981` and `#3b82f6` respectively if no color is provided.

### Image Uploads

Uploaded images are stored on disk under an `uploads/` directory. The `/upload` endpoint returns a relative path like `/files/<filename>` which clients combine with the server URL to load the image. Filenames are sanitized before saving to prevent path traversal.

`docker-compose.yml` mounts a volume for the uploads directory so files persist between restarts.

## Docker
A `docker-compose.yml` runs the Rust server alongside Postgres. The client is run locally without Docker.

## Development
Run `npm run check` in `murmer_client` to lint Svelte and TypeScript sources.
Format the server code with `cargo fmt` before committing changes.

## Building on Windows

1. Install the [Tauri prerequisites](https://v2.tauri.app/start/prerequisites/) for Windows.
2. Ensure [Rust](https://www.rust-lang.org/tools/install) and [Node.js](https://nodejs.org) are in your `PATH`.
3. From the `murmer_client` folder run:

   ```bash
   npm install
   npm run tauri build
   ```
   The built installer can be found in `murmer_client/src-tauri/target/release/bundle`.
4. Build the server executable (optional):

   ```bash
   cd ../murmer_server
   cargo build --release
   ```

   The binary will be at `murmer_server/target/release/murmer_server`.

## Contributing

Pull requests are welcome! Please follow these guidelines:

1. Format Rust code using `cargo fmt`.
2. Run `npm run check` from `murmer_client` and ensure there are no errors.
3. Keep commits focused on a single change.
4. Update documentation when changing or adding features.

## Notes
This project is an early prototype demonstrating login, server selection, text chat and a stub for voice communication via WebRTC.

## Development Guides

For more detailed information on development workflows, see:
- [murmer_client/AGENTS.md](murmer_client/AGENTS.md) – guides for the Tauri/SvelteKit client.
- [murmer_server/AGENTS.md](murmer_server/AGENTS.md) – guides for the Rust WebSocket server.

## Building for production

### Client
Build and bundle the desktop application using Tauri:
```bash
cd murmer_client
npm install
npm run build         # build web assets
npm run tauri build   # package native installer
```
Generated bundles are placed under `src-tauri/target/release/bundle`.

### Server
Compile the Rust server in release mode:
```bash
cargo build --release
```
The optimized binary is available at `murmer_server/target/release/murmer_server`.
